<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk Employee Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 2rem; max-width: 800px; margin: 0 auto; background: #f8f9fa; }
        .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #333; }
        input { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        button { padding: 0.75rem 1.2rem; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .save-btn { background: #007bff; color: white; width: 100%; font-size: 1.1rem; }
        .qr-btn { background: #28a745; color: white; }
        .delete-btn { background: #dc3545; color: white; }
        
        li { background: white; margin: 10px 0; padding: 1rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        
        /* Modal for Kiosk QR Display */
        #qrModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; flex-direction: column; color: white; }
        #qrContainer { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .close-modal { background: white; color: black; padding: 10px 20px; }
    </style>
</head>
<body>

<div class="card" id="mainContent">
    <h1>Kiosk Data Entry</h1>
    <form id="employeeForm">
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="name" required placeholder="John Doe">
        </div>
        <div class="form-group">
            <label>Birthday</label>
            <input type="date" id="birthday" required>
        </div>
        <button type="submit" class="save-btn">Save Employee</button>
    </form>

    <h2>Recent Entries</h2>
    <ul id="employeeList"></ul>
</div>

<div id="qrModal">
    <h2 style="margin-bottom: 10px;">Scan to Download PDF</h2>
    <div id="qrContainer"></div>
    <button class="close-modal" onclick="closeModal()">Close</button>
</div>

<script>
    const dbName = 'KioskDB';
    const storeName = 'employees';
    let db;

    // --- 1. MOBILE LOGIC: Check if URL has download data ---
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        if (params.has('download')) {
            // Hide the UI for the mobile user
            document.getElementById('mainContent').innerHTML = "<h1>Generating PDF...</h1><p>Your download should start automatically.</p>";
            
            const empData = {
                name: params.get('name'),
                birthday: params.get('birthday')
            };
            
            // Generate PDF on the phone
            setTimeout(() => {
                generatePDF(empData);
            }, 500);
        } else {
            initDB();
        }
    };

    function initDB() {
        const request = indexedDB.open(dbName, 1);
        request.onupgradeneeded = e => e.target.result.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
        request.onsuccess = e => { db = e.target.result; displayEmployees(); };
    }

    // --- 2. KIOSK LOGIC: Save and Display ---
    document.getElementById('employeeForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const entry = { 
            name: document.getElementById('name').value, 
            birthday: document.getElementById('birthday').value 
        };
        const transaction = db.transaction([storeName], 'readwrite');
        transaction.objectStore(storeName).add(entry).onsuccess = () => {
            e.target.reset();
            displayEmployees();
        };
    });

    function displayEmployees() {
        const list = document.getElementById('employeeList');
        list.innerHTML = '';
        db.transaction([storeName], 'readonly').objectStore(storeName).getAll().onsuccess = (e) => {
            e.target.result.forEach(emp => {
                const li = document.createElement('li');
                li.innerHTML = `<span><strong>${emp.name}</strong></span>`;
                
                const btnGroup = document.createElement('div');
                const qrBtn = document.createElement('button');
                qrBtn.textContent = 'Get QR';
                qrBtn.className = 'qr-btn';
                qrBtn.onclick = () => showKioskQR(emp);
                
                btnGroup.appendChild(qrBtn);
                li.appendChild(btnGroup);
                list.appendChild(li);
            });
        };
    }

    // --- 3. QR GENERATION (The Bridge) ---
    function showKioskQR(emp) {
        const qrContainer = document.getElementById('qrContainer');
        qrContainer.innerHTML = '';
        
        // Build the URL that the phone will open
        // It points back to this page but adds the employee data in the URL
        const baseUrl = window.location.origin + window.location.pathname;
        const scanUrl = `${baseUrl}?download=true&name=${encodeURIComponent(emp.name)}&birthday=${emp.birthday}`;
        
        new QRCode(qrContainer, {
            text: scanUrl,
            width: 250,
            height: 250
        });
        
        document.getElementById('qrModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('qrModal').style.display = 'none';
    }

    // --- 4. PDF GENERATION (Shared by Kiosk and Phone) ---
    function generatePDF(emp) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(22);
        doc.text("Employee Document", 20, 20);
        doc.setFontSize(14);
        doc.text(`Name: ${emp.name}`, 20, 40);
        doc.text(`Birthday: ${emp.birthday}`, 20, 50);
        doc.text(`Date Exported: ${new Date().toLocaleDateString()}`, 20, 60);
        
        doc.save(`Record_${emp.name}.pdf`);
    }
</script>
</body>
</html>